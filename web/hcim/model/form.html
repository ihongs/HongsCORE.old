<object class="config" name="hsInit" data="">
    <param name="width" value="800px"/>
</object>

<h2 class="hide-in-tabs">${opt}模型</h2>

<div id="hcim-model-form">
    <object class="config" name="hsForm" data="">
        <param name="WithoutIdAlsoLoad" value="1"/>
        <param name="loadUrl" value="hcim/Model/Info.act"/>
        <param name="saveUrl" value="hcim/Model/Save.act"/>
        <param name="_fill__choose" value="(hsFillFormChoose)"/>
    </object>
    <form action="" method="POST">
        <input type="hidden" name="id"/>
        <div class="form-group">
            <label class="control-label">所属模块</label>
            <div class="choose-box" data-fn="module_id" data-ft="_choose"></div>
            <button type="button" class="btn btn-default" data-toggle="hsChoose" data-url="hcim/module/select.html">选择模块</button>
        </div>
        <div class="form-group">
            <label class="control-label">模型名称</label>
            <input type="text" name="name" class="form-control" required="required" data-unique="hcim/Model/Unique.act?id={id}"/>
        </div>
        <div class="form-group">
            <label class="control-label">代号</label>
            <input type="text" name="code" class="form-control" data-unique="hcim/Model/Unique.act?id={id}"/>
        </div>
        <div class="form-group">
            <label class="control-label">备注</label>
            <textarea name="note" class="form-control"></textarea>
        </div>
        
        <fieldset class="cols-box">
            <legend class="dropdown-toggle">字段设置 <span class="caret"></span></legend>
            <div class="dropdown-body list-box">
                <table class="table">
                    <thead>
                        <tr>
                            <td class="cols-set-hand">&nbsp;</td>
                            <td class="cols-set-name">名称</td>
                            <td class="cols-set-code">代号</td>
                            <td class="cols-set-type">类型</td>
                            <td class="cols-set-size">长度</td>
                            <td class="cols-set-scale">精度</td>
                            <td class="cols-set-remove">&nbsp;</td>
                        </tr>
                    </thead>
                </table>
                <div class="cols-set-box">
                </div>
                <button type="button" class="add-col btn btn-default">添加字段</button>
            </div>
        </fieldset>
        
        <div>
            <button type="submit" class="ensure btn btn-primary">提交</button>
            <button type="button" class="cancel btn btn-link">取消</button>
        </div>
    </form>
</div>

<style type="text/css">
    #hcim-model-form .list-box tbody td
        {padding: 0;}
    #hcim-model-form .list-box tbody td select,
    #hcim-model-form .list-box tbody td input
        {min-width: 98%; width: 98%; height: 98%; border: 0; margin: 0; padding: 0;}
    #hcim-model-form .list-box tbody td input
        {padding: 0 6px;}
    #hcim-model-form .cols-box
        {margin-bottom: 2em;}
    #hcim-model-form .cols-box .list-box,
    #hcim-model-form .cols-box .list-box table
        {background: #FFFFEF;}
    #hcim-model-form .cols-set-hand
        {width: 2em;}
    #hcim-model-form .cols-set-code
        {width: 15em;}
    #hcim-model-form .cols-set-type,
    #hcim-model-form .cols-set-size,
    #hcim-model-form .cols-set-scale,
    #hcim-model-form .cols-set-remove
        {width: 10em;}
    #hcim-model-form .cols-set-remove
        {text-align: center;}
</style>

<script type="text/javascript">
(function($) {
    var context = $("#hcim-model-form");
    var valueTypes;

    context.find(".cols-set-box").sortable({
        items : "> table",
        handle: ".cols-set-hand"
    });

    /** 字段设置 **/

    var tab = "a_hcim_model_cols";
    var idx = 0;

    function addCol(col) {
        idx ++;
        var tb = $('<table class="table"><tbody><tr></tr></tbody></table>');
        var nm = $('<input type="text" name="'+tab+'['+idx+'][name]"/>' );
        var cd = $('<input type="text" name="'+tab+'['+idx+'][code]"/>' );
        var ft = $('<select name="'+tab+'['+idx+'][value_type]"></select>');
        var fs = $('<input type="number" name="'+tab+'['+idx+'][value_size]" min="1"/>' );
        var fc = $('<input type="number" name="'+tab+'['+idx+'][value_scale]" min="0" max="9"/>');
        var bt = $('<button type="button" class="del-col btn btn-danger">删除</button>');
        tb.appendTo(context.find(".cols-set-box")).find("tr")
            .append($('<td class="cols-set-hand"></td>'))
            .append($('<td class="cols-set-name"></td>').append(nm))
            .append($('<td class="cols-set-code"></td>').append(cd))
            .append($('<td class="cols-set-type"></td>').append(ft))
            .append($('<td class="cols-set-size"></td>').append(fs))
            .append($('<td class="cols-set-scale"></td>').append(fc))
            .append($('<td class="cols-set-remove"></td>').append(bt));
        for(var i = 0; i < valueTypes.length; i ++) {
            var a = valueTypes[i];
            ft.append($('<option></option>').val(a[0]).text(a[1]));
        }
        if (col) {
            nm.val(col.name);
            cd.val(col.code);
            ft.val(col.value_type);
            fs.val(col.value_size);
            fc.val(col.value_scale);
        }
    }

    context.on("loadBack", function(evt, rst) {
        if (rst.data) {
            valueTypes = rst.data.MODEL_VALUE_TYPES;
        }
        if (rst.info) {
            var a = rst.info.a_hcrm_dataset_cols;
            if (a) {
                for (var i = 0; i < a.length; i ++) {
                    addCol(a[i]);
                }
            }
        }
    });
    context.on("click", ".add-col", function() {
        addCol();
    });
    context.on("click", ".del-col", function() {
        $(this).closest("table").remove();
    });

})( jQuery );
</script>
