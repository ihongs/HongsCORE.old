<object class="config" name="hsInit" data="">
    <param name="width" value="800px"/>
</object>

<h2 class="hide-in-tabs">${opt}实体</h2>

<div id="hcim-entity-form">
    <object class="config" name="hsForm" data="">
        <param name="loadNoId" value="1"/>
        <param name="loadUrl" value="hcim/Entity/Info.act"/>
        <param name="saveUrl" value="hcim/Entity/Save.act"/>
        <param name="_fill__choose" value="(hsFillFormChoose)"/>
    </object>
    <form action="" method="POST">
        <input type="hidden" name="id"/>
        <div class="form-group">
            <label class="control-label">所属模块</label>
            <input type="hidden" data-fn="module_id" data-ft="_choose"/>
            <button type="button" class="btn btn-default" data-toggle="hsChoose" data-url="hcim/module/choose.html" style="display: block;">选择模块</button>
        </div>
        <div class="form-group">
            <label class="control-label">实体名称</label>
            <input type="text" name="name" class="form-control" required="required" data-unique="hcim/Entity/Unique.act?id={id}"/>
        </div>
        <div class="form-group">
            <label class="control-label">备注</label>
            <textarea name="note" class="form-control"></textarea>
        </div>
        
        <fieldset class="cols-box">
            <legend class="dropdown-toggle">属性设置 <span class="caret"></span></legend>
            <div class="dropdown-body list-box">
                <div class="cols-set-box">
                </div>
                <button type="button" class="add-col btn btn-default">添加属性</button>
            </div>
        </fieldset>
        
        <fieldset class="rels-box">
            <legend class="dropdown-toggle">关联设置 <span class="caret"></span></legend>
            <div class="dropdown-body list-box">
                <div class="rels-set-box">
                </div>
                <button type="button" class="add-rel btn btn-default">添加关联</button>
            </div>
        </fieldset>
        
        <div>
            <button type="submit" class="ensure btn btn-primary">提交</button>
            <button type="button" class="cancel btn btn-link">取消</button>
        </div>
    </form>
</div>

<style type="text/css">
    #hcim-entity-form .cols-box .list-box,
    #hcim-entity-form .rels-box .list-box
        {background: #FFFFAA;}
    #hcim-entity-form .cols-box .btn-group,
    #hcim-entity-form .rels-box .btn-group
        {background: #FFFFCC; margin-bottom: 2px; display: block;}
    #hcim-entity-form .cols-box .btn-group .btn-default,
    #hcim-entity-form .rels-box .btn-group .btn-default
        {margin-right: 2px; width: 174.5px; overflow: hidden; text-align: left;}
    #hcim-entity-form .cols-box .btn-group .form-control,
    #hcim-entity-form .rels-box .btn-group .form-control
        {margin-right: 2px; width: 174.5px; display: inline-block; float: left;}
</style>

<script type="text/javascript">
(function($) {
    var context = $("#hcim-entity-form");
    var valueTypes;

    context.find(".cols-set-box").sortable({
        items : ">.btn-group"
    });
    context.find(".rels-set-box").sortable({
        items : ">.btn-group"
    });

    /** 字段和关系设置 **/

    var colTab = "a_hcim_entity_cols";
    var relTab = "a_hcim_entity_rels";
    var colIdx = 0;
    var relIdx = 0;

    function addCol(col) {
        colIdx ++;
        var name = $('<input type="text" name="'+colTab+'['+colIdx+'][name]" placeholder="字段名称" class="form-control fl"/>' );
        var attr = $('<input type="hidden" name="'+colTab+'['+colIdx+'][attr_id]"/>');
        var attrBtn = $('<button type="button" class="sel-attr btn btn-default">选择属性</button>');
        var delBtn = $('<button type="button" class="del-col btn btn-warning">&times;</button>');
        $('<div class="btn-group from-inline"></div>')
                .append($('<div class="fl"></div>').append(name))
                .append($('<div class="fl"></div>').append(attr).append(attrBtn))
                .append(delBtn)
                .append('<div class="cb"></div>')
                .appendTo(context.find('.cols-set-box'));
        if (col) {
            name.val(col.name);
            attr.val(col.attr_id);
            attrBtn.text(col.attr.name);
        }
        attrBtn.hsChoose({url: "hcim/domain/choose.html"});
    }
    
    function addRel(rel) {
        relIdx ++;
        var type = $('<input type="hidden" name="'+relTab+'['+relIdx+'][type]"/>');
        var typeBtn = $('<button type="button" class="sel-type btn btn-default">选择类型</button>');
        var link = $('<input type="hidden" name="'+relTab+'['+relIdx+'][link_id]"/>');
        var linkBtn = $('<button type="button" class="sel-link btn btn-default">选择关联</button>');
        var delBtn = $('<button type="button" class="del-col btn btn-warning">&times;</button>');
        $('<div class="btn-group"></div>')
                .append($('<div class="fl"></div>').append(type).append(typeBtn))
                .append($('<div class="fl"></div>').append(link).append(linkBtn))
                .append(delBtn)
                .append('<div class="cb"></div>')
                .appendTo(context.find('.rels-set-box'));
        if (rel) {
            type.val(rel.type);
            typeBtn.text(rel.type_name);
            link.val(rel.link_id);
            linkBtn.text(rel.link.name);
        }
        linkBtn.hsChoose({url: "hcim/entity/choose.html"});
        typeBtn.hsChoose({url: "hcim/entity/choose-rels-type.html"});
    }

    context.on("loadBack", function(evt, rst) {
        if (rst.data) {
            valueTypes = rst.data.ENTITY_VALUE_TYPES;
        }
        if (rst.info) {
            var a, i;
            a = rst.info.a_hcim_entity_cols;
            if (a) {
                for (i = 0; i < a.length; i ++) {
                    addCol(a[i]);
                }
            }
            a = rst.info.a_hcim_entity_rels;
            if (a) {
                for (i = 0; i < a.length; i ++) {
                    addRel(a[i]);
                }
            }
        }
    });
    context.on("click", ".add-col", function() {
        addCol();
    });
    context.on("click", ".del-col", function() {
        $(this).closest(".btn-group").remove();
    });
    context.on("click", ".add-rel", function() {
        addRel();
    });
    context.on("click", ".del-rel", function() {
        $(this).closest(".btn-group").remove();
    });
})( jQuery );
</script>
