<object class="config" name="hsInit" data="">
    <param name="width" value="800px"/>
</object>

<h2 class="hide-in-tabs">${opt}实体</h2>

<div id="hcim-entity-form">
    <object class="config" name="hsForm" data="">
        <param name="loadNoId" value="1"/>
        <param name="loadUrl" value="hcim/Entity/Info.act"/>
        <param name="saveUrl" value="hcim/Entity/Save.act"/>
        <param name="_fill__pick" value="(hsFormFillPick)"/>
    </object>
    <form action="" method="POST">
        <input type="hidden" name="id"/>
        <div class="form-group">
            <label class="control-label">所属模块</label>
            <div data-fn="module_id" data-ft="_pick"></div>
            <button type="button" class="btn btn-default" data-toggle="hsPick" href="hcim/module/pick.html" style="display: block;">选择模块</button>
        </div>
        <div class="form-group">
            <label class="control-label">实体名称</label>
            <input type="text" name="name" class="form-control" required="required" data-unique="hcim/Entity/Unique.act?id={id}&module_id={module_id}"/>
        </div>
        <div class="form-group">
            <label class="control-label">代码</label>
            <input type="text" name="code" class="form-control" required="required" data-unique="hcim/Entity/Unique.act?id={id}&module_id={module_id}"/>
        </div>
        <div class="form-group">
            <label class="control-label">备注</label>
            <textarea name="note" class="form-control"></textarea>
        </div>
        
        <fieldset class="cols-box">
            <legend class="dropdown-toggle">属性设置 <span class="caret"></span></legend>
            <div class="dropdown-body list-box">
                <div class="cols-set-box">
                </div>
                <button type="button" class="add-col btn btn-default">添加属性</button>
            </div>
        </fieldset>
        
        <fieldset class="rels-box">
            <legend class="dropdown-toggle">关联设置 <span class="caret"></span></legend>
            <div class="dropdown-body list-box">
                <div class="rels-set-box">
                </div>
                <button type="button" class="add-rel btn btn-default">添加关联</button>
            </div>
        </fieldset>
        
        <fieldset class="rels-box">
            <legend class="dropdown-toggle">唯一约束 <span class="caret"></span></legend>
            <div class="dropdown-body list-box">
            </div>
        </fieldset>
        
        <div>
            <button type="submit" class="ensure btn btn-primary">提交</button>
            <button type="button" class="cancel btn btn-link">取消</button>
        </div>
    </form>
</div>

<style type="text/css">
    #hcim-entity-form .cols-box .list-box,
    #hcim-entity-form .rels-box .list-box
        {background: #FFFFAA; padding: 2px 0 2px 0;}
    #hcim-entity-form .cols-box .btn-group,
    #hcim-entity-form .rels-box .btn-group
        {background: #FFFFCC; margin-bottom: 2px; display: block;}
    #hcim-entity-form .cols-box .btn-group .btn-default,
    #hcim-entity-form .rels-box .btn-group .btn-default
        {margin-right: 2px; width: 174.5px; overflow: hidden; text-align: left;}
    #hcim-entity-form .cols-box .btn-group .form-control,
    #hcim-entity-form .rels-box .btn-group .form-control
        {margin-right: 2px; width: 174.5px; display: inline-block; float: left;}
</style>

<script type="text/javascript">
(function($) {
    var context = $("#hcim-entity-form");
    var valueTypes;

    context.find(".cols-set-box").sortable({
        items : ">.btn-group"
    });
    context.find(".rels-set-box").sortable({
        items : ">.btn-group"
    });

    /** 字段和关系设置 **/

    var colTab = "a_hcim_entity_cols";
    var relTab = "a_hcim_entity_rels";
    var colIdx = 0;
    var relIdx = 0;

    function addCol(col) {
        colIdx ++;
        
        var attr = colTab+'['+colIdx+'][domain_id]';
        var name = colTab+'['+colIdx+'][name]';
        
        var nameInp = $('<input type="text" name="'+name+'" placeholder="字段名称" class="form-control fl"/>' );
        var attrInp = $('<input type="hidden" name="'+attr+'"/>');
        var attrBtn = $('<button type="button" class="sel-attr btn btn-default">选择属性</button>');
        var  delBtn = $('<button type="button" class="del-col btn btn-warning">&times;</button>');
        $('<div class="btn-group from-inline"></div>')
                .append($('<div class="fl"></div>').append(nameInp))
                .append($('<div class="fl"></div>').append(attrInp).append(attrBtn))
                .append(delBtn)
                .append('<div class="cb"></div>')
                .appendTo(context.find('.cols-set-box'));
        if (col) {
            nameInp.val (col.name);
            attrInp.val (col.domain_id);
            attrBtn.text(col.domain.name);
        }
        
        attrBtn.attr("data-toggle", "hsPick")
               .attr("href", "hcim/domain/pick.html");
    }
    
    function addRel(rel) {
        relIdx ++;
        
        var link = relTab+'['+relIdx+'][relate_id]';
        var type = relTab+'['+relIdx+'][type]';
        
        var typeSel = $('<select name="'+type+'" class="form-control">'
            +'<option value="1">隶属于</option>'
            +'<option value="2">一对一</option>'
            +'<option value="1">一对多</option>'
            +'<option value="1">多对多</option>'
            +'</select>');
        var linkInp = $('<input type="hidden" name="'+link+'"/>');
        var linkBtn = $('<button type="button" class="sel-link btn btn-default">选择关联</button>');
        var  delBtn = $('<button type="button" class="del-col btn btn-warning">&times;</button>');
        $('<div class="btn-group"></div>')
                .append($('<div class="fl"></div>').append(typeSel))
                .append($('<div class="fl"></div>').append(linkInp).append(linkBtn))
                .append(delBtn)
                .append('<div class="cb"></div>')
                .appendTo(context.find('.rels-set-box'));
        if (rel) {
            typeSel.val (rel.type);
            linkInp.val (rel.relate_id);
            linkBtn.text(rel.relate.name);
        }
        
        linkBtn.attr("data-toggle", "hsPick")
               .attr("href", "hcim/entity/pick.html?deny=create");
    }

    context.on("loadBack", function(evt, rst) {
        if (rst.data) {
            valueTypes = rst.data.ENTITY_VALUE_TYPES;
        }
        if (rst.info) {
            var a, i;
            a = rst.info.a_hcim_entity_cols;
            if (a) {
                for (i = 0; i < a.length; i ++) {
                    addCol(a[i]);
                }
            }
            a = rst.info.a_hcim_entity_rels;
            if (a) {
                for (i = 0; i < a.length; i ++) {
                    addRel(a[i]);
                }
            }
        }
    });
    context.on("click", ".add-col", function() {
        addCol();
    });
    context.on("click", ".del-col", function() {
        $(this).closest(".btn-group").remove();
    });
    context.on("click", ".add-rel", function() {
        addRel();
    });
    context.on("click", ".del-rel", function() {
        $(this).closest(".btn-group").remove();
    });
})( jQuery );
</script>
